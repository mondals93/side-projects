---
title: "Titanic ML"
author: "Sangeeta Mondal"
output: rmarkdown::github_document
---
##Objective

The sinking of the RMS Titanic is one of the most notable shipwrecks in history. After colliding with an iceberg, the Titanic had killed 1502 of 2224 passengers and crew on board. The main objective of this project is to build a model that predicts whether a passenger is going to survive based on different predictors such as age, gender and passenger class. The second objective of this project is understand which covariates are the most valuable in the prediction of survival. Machine learning algorithm Random Forest will be used to predict survival. 

##Data Source 

The data in this study was collected from 1309 randomly selected passengers on the Titanic. The outcome variable, 'Survival', was a dichotomous variable with 1 representing survival and 0 representing death. There were 12 total variables in the dataset. Certain covariates were not included in the analysis (discussed later). There were also missing observations in the dataset (discussed later).


##Preprocessing the Dataset

```{r message = FALSE, warning = FALSE} 
require(ggplot2)
require(knitr)
require(ggthemes)
require(mice)
require(randomForest)
require(gmodels)
require(MLmetrics)
require(dplyr)
require(caTools)
require(gridExtra)
```

```{r}
train<-read.csv('C:/Users/PC/Documents/Biostat 273/train.csv', stringsAsFactors = F)
test<-read.csv('C:/Users/PC/Documents/Biostat 273/test.csv', stringsAsFactors = F)

all<-bind_rows(train, test)
```


```{r}
all_levs<-apply(all,2,unique)
dim(all) 


#factor variables
all$Survived<-as.factor(all$Survived)
all$Sex<-as.factor(all$Sex)
all$Embarked<-as.factor(all$Embarked)

#numeric variables
all$PassengerId<-as.numeric(all$PassengerId)
all$Age<-as.numeric(all$Age)
all$SibSp<-as.numeric(all$SibSp)
all$Parch<-as.numeric(all$Parch)
all$Fare<-as.numeric(all$Fare)
all$Pclass<-as.numeric(all$Pclass)

#cabin and embarked have blanks -- fill in blanks with NAs
all$Cabin[all$Cabin == '']<-NA
all$Embarked[all$Embarked == '']<-NA
```

##Feature Engineering
In order to increase accuracy of prediction, new features that were potentially thought to be correlated to survival were constructed. Two new
features were created. The first one was 'Title'. The titles of the passengers were extracted and then were categorized into 5 groups: Miss, Mrs, Mr, Master, and Other Title. Essentially, 'Title' can be viewed as age-by-gender interaction term. The second feature created was an interaction term between sex and passenger class called 'SexP'. 

```{r}
#Title
all$Title<- gsub('(.*, )|(\\..*)', '', all$Name)

other <- c('Dona', 'Lady', 'the Countess','Capt', 'Col', 'Don', 
           'Dr', 'Major', 'Rev', 'Sir', 'Jonkheer') #collapse uncommon titles into one category

all$Title[all$Title == 'Mlle']<- 'Miss' 
all$Title[all$Title == 'Ms']<- 'Miss'
all$Title[all$Title == 'Mme']<- 'Mrs' 
all$Title[all$Title %in% other]<-'Other Title'
all$Title<-as.factor(all$Title)

#Interaction term between Sex and Pclass-->recode and then multiply terms
all$Sex_N<-ifelse(all$Sex == 'female', 1, 0)
all$SexP<-all$Sex_N * all$Pclass
```

The data will be split back into a training and test set. 
```{r}
#Split back into training and test
train<-all[1:891,]
test<-all[892:1309,]
```

For now, we will ignore the test set. The training test will be split 80/20.80% of the train data will be the observations that we train our algorithm with. The other 20% will serve as the validation set. Hence, the training set had 713 observations while the test set had  178 observations.

```{r}
set.seed(307)
samp_d<-sample.split(train$Survived, SplitRatio = .8)
n_train<-subset(train, samp_d == TRUE)
n_test<-subset(train, samp_d == FALSE)
```

##Descriptive Statistics
Both the training and test sets were split into two groups. The first group contained quantitative variables (both discrete and continous types). The second group contained qualitative variables. In doing the analysis, 
certain variables were omitted: PassengerID, Name, Ticket, Cabin, and Sex_N. 'PassengerID' and 'Name'was omitted because it was unique to every passenger and no important information could be analyzed from it. 'Ticket' was less variant but still fairly unique to every passenger so it was also omitted. 'Cabin' had too much missing information so it was dropped as well. Finally, 'Sex_N' was dropped from the analysis as well because it was recoded from the 'Sex' variable; hence, it was redundant.  


```{r}
cont<-c('Age', 'SibSp', 'Parch', 'Fare')

train_cont<-n_train[,cont]
train_oth<-n_train[,!names(n_train) %in% cont]
train_oth<-train_oth[,!names(train_oth) %in% c('PassengerId',
                                             'Name',
                                             'Ticket',
                                             'Cabin',
                                             'Sex_N')]

test_cont<-n_test[,cont]
test_oth<-n_test[,!names(n_test) %in% cont]
test_oth<-test_oth[,!names(test_oth) %in% c('PassengerId',
                                             'Name',
                                             'Ticket',
                                             'Cabin',
                                             'Sex_N')] 
```

```{r}
#summary stats fxn-- quant variables
sumCont<-function(var){
  c(mean(var, na.rm = TRUE), median(var, na.rm = TRUE), 
    sd(var, na.rm = TRUE), sum(is.na(var)))
}

#summary stats fxn-- qual vars
sumCat<-function(var){
  l<-c()
  for (level in sort(unique(var))){
    prop<-round(length(which(var == level))/length(var),2)
    l<-c(prop, l)
  }
  if (length(l)<5){
    l<-c(l, rep('NA', 5-length(l)))
  }
  l<-c(l, sum(is.na(var)))
  return(l)
}

#continuous vars
sumContTr<-apply(train_cont, 2, sumCont)
sumContTr<-t(round(sumContTr,2))
sumContTe<-apply(test_cont, 2, sumCont)
sumContTe<-t(round(sumContTe, 2))

allCont<-cbind(sumContTr, sumContTe)
colnames(allCont)<-c('Train: Mean', 'Train: Median', 'Train: SD', 'Train: Missing Values', 'Test: Mean', 'Test: Median', 'Test: SD', 'Test: Missing Values')
kable(allCont, caption = 'Table 1. Summary Statistics of Quantitative Variables for Both Training and Test Sets')
```

Based on table 1, there are no remarkable differences in the summary statistics between the training and test sets. The passengers in the test set did seem to have slightly higher fares. Furthermore, the large numbers of missing age values in both sets should be noted as well. 

```{r}
#categorical vars
sumCatTr<-apply(train_oth, 2, sumCat)
sumCatTr<-t(sumCatTr)

sumCatTe<-apply(test_oth, 2, sumCat)
sumCatTe<-t(sumCatTe)

allCat<-cbind(sumCatTr, sumCatTe)
colnames(allCat)<-c('Train: Cat 1', 'Cat 2', 'Cat 3', 'Cat 4','Cat 5', 'Missing Values', 'Test: Cat 1', 'Cat 2', 'Cat 3', 'Cat 4', 'Cat 5', 'Missing Values')

kable(allCat, caption = 'Fig 2. Summary Statistics for the Qualitative Variables in the Training and Test Dataset. If the variable did not have the max categories as listed in the table, it was assigned a NA value')
```

Figure 2 describes the qualitative variables in the dataset. The proportion of passengers per level of each variable was tabulated. It can be seen that there are no major differences in the distributions of each variable. Furthermore, 'Embarked' has 2 missing values. 

##Exploring Associations Between Survival and Other Covariates